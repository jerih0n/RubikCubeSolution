@using RubikCubeSolution.Logic.Enums
@using RubikCubeSolution.Web.Helpers
@model MatrixCellFillEnum[,]

@{
    ViewData["Title"] = "Rubik's Cube Matrix";
}

<div class="container mt-4">
    <h1 class="text-center mb-4">Rubik's Cube Matrix</h1>
    
    <!-- Button Press History -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="history-container">
                <h5 class="text-center mb-3">Button Press History</h5>
                <div class="history-list" id="historyList">
                    <p class="text-muted text-center">No rotations yet</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Matrix Container - Centered and Larger -->
    <div class="d-flex justify-content-center align-items-center matrix-wrapper">
        <div class="matrix-container" id="matrixContainer">
            @for (int i = 0; i < Model.GetLength(0); i++)
            {
                <div class="matrix-row">
                    @for (int j = 0; j < Model.GetLength(1); j++)
                    {
                        var cellValue = Model[i, j];
                        @if (cellValue != MatrixCellFillEnum.None)
                        {
                            var hexColor = ColorMappingHelper.GetHexColor(cellValue);
                            <div class="matrix-cell" style="background-color: @hexColor;" 
                                 title="@cellValue.ToString() (@i, @j)"></div>
                        }
                        else
                        {
                            <div class="matrix-cell-empty"></div>
                        }
                    }
                </div>
            }
        </div>
    </div>
    
    <!-- Rotation Controls - Below Matrix -->
    <div class="rotation-controls mt-4">
        <!-- First Row: Clockwise Rotations -->
        <div class="row justify-content-center mb-3">
            <div class="col-auto">
                <div class="btn-group-horizontal" role="group">
                    <button class="btn btn-secondary rotation-btn" data-instruction="F">F</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="R">R</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="U">U</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="B">B</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="L">L</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="D">D</button>
                </div>
            </div>
        </div>
        
        <!-- Second Row: Counter-Clockwise Rotations -->
        <div class="row justify-content-center mb-3">
            <div class="col-auto">
                <div class="btn-group-horizontal" role="group">
                    <button class="btn btn-secondary rotation-btn" data-instruction="F'">F'</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="R'">R'</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="U'">U'</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="B'">B'</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="L'">L'</button>
                    <button class="btn btn-secondary rotation-btn" data-instruction="D'">D'</button>
                </div>
            </div>
        </div>
        
        <!-- Reset Button -->
        <div class="row justify-content-center">
            <div class="col-auto">
                <button class="btn btn-secondary reset-btn" id="resetBtn">Reset Cube</button>
            </div>
        </div>
    </div>
</div>

<style>
    .matrix-wrapper {
        min-height: 400px;
        margin: 2rem 0;
    }
    
    .matrix-container {
        border: 3px solid #333;
        padding: 10px;
        background-color: #f0f0f0;
        display: inline-block;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .matrix-row {
        display: flex;
    }
    
    .matrix-cell {
        width: 50px;
        height: 50px;
        border: 2px solid #999;
        margin: 2px;
        cursor: pointer;
        transition: transform 0.1s;
        border-radius: 3px;
    }
    
    .matrix-cell:hover {
        transform: scale(1.1);
        z-index: 1;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    
    .matrix-cell-empty {
        width: 50px;
        height: 50px;
        margin: 2px;
    }
    
    .rotation-controls {
        margin-top: 2rem;
    }
    
    .btn-group-horizontal {
        display: flex;
        flex-direction: row;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .rotation-btn {
        width: 60px;
        height: 60px;
        padding: 0;
        font-size: 18px;
        font-weight: 600;
        border: 2px solid #6c757d;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .rotation-btn:hover:not(:disabled) {
        background-color: #5a6268;
        border-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    
    .rotation-btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .rotation-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .reset-btn {
        min-width: 140px;
        padding: 8px 20px;
        font-size: 14px;
        font-weight: 600;
        border: 2px solid #6c757d;
        border-radius: 25px;
        background-color: #6c757d;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .reset-btn:hover:not(:disabled) {
        background-color: #5a6268;
        border-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    
    .reset-btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .reset-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .history-container {
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        min-height: 60px;
        overflow-x: auto;
        overflow-y: hidden;
    }
    
    .history-list {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: flex-start;
    }
    
    .history-item {
        padding: 6px 12px;
        background-color: white;
        border: 2px solid #6c757d;
        border-radius: 15px;
        white-space: nowrap;
        display: inline-block;
    }
    
    .history-item:first-child {
        margin-top: 0;
    }
</style>

<script>
    const colorMap = {
        0: 'transparent',  // None
        1: '#FF6B35',      // Orange
        2: '#FFFFFF',      // White
        3: '#00A651',      // Green
        4: '#FFD700',      // Yellow
        5: '#DC143C',      // Red
        6: '#0066CC'       // Blue
    };

    // Button press history array
    let buttonPressHistory = [];

    document.addEventListener('DOMContentLoaded', function() {
        const rotationButtons = document.querySelectorAll('.rotation-btn');
        
        rotationButtons.forEach(button => {
            button.addEventListener('click', function() {
                const instruction = this.getAttribute('data-instruction');
                addToHistory(instruction);
                performRotation(instruction);
            });
        });

        const resetButton = document.getElementById('resetBtn');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                resetCube();
            });
        }
        
        // Initialize history display
        updateHistoryDisplay();
    });
    
    function addToHistory(instruction) {
        buttonPressHistory.push(instruction);
        updateHistoryDisplay();
    }
    
    function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        
        if (buttonPressHistory.length === 0) {
            historyList.innerHTML = '<p class="text-muted text-center">No rotations yet</p>';
        } else {
            let html = '';
            // Show history in chronological order (oldest to newest)
            for (let i = 0; i < buttonPressHistory.length; i++) {
                html += `<div class="history-item">${buttonPressHistory[i]}</div>`;
            }
            historyList.innerHTML = html;
            // Scroll to the end to show most recent items
            historyList.scrollLeft = historyList.scrollWidth;
        }
    }

    function performRotation(instruction) {
        // Disable all buttons during rotation
        const allButtons = document.querySelectorAll('.rotation-btn, .reset-btn');
        allButtons.forEach(btn => btn.disabled = true);

        fetch('/Home/Rotate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ instruction: instruction })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || 'Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.matrix) {
                updateMatrix(data.matrix);
            } else {
                throw new Error('Invalid response format');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error performing rotation: ' + error.message);
        })
        .finally(() => {
            // Re-enable all buttons
            allButtons.forEach(btn => btn.disabled = false);
        });
    }

    function updateMatrix(matrix) {
        const container = document.getElementById('matrixContainer');
        container.innerHTML = '';

        for (let i = 0; i < matrix.length; i++) {
            const row = document.createElement('div');
            row.className = 'matrix-row';

            for (let j = 0; j < matrix[i].length; j++) {
                const cellValue = matrix[i][j];
                
                if (cellValue !== 0) { // Not None
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.style.backgroundColor = colorMap[cellValue];
                    cell.title = getColorName(cellValue) + ' (' + i + ', ' + j + ')';
                    row.appendChild(cell);
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'matrix-cell-empty';
                    row.appendChild(emptyCell);
                }
            }

            container.appendChild(row);
        }
    }

    function getColorName(value) {
        const names = {
            0: 'None',
            1: 'Orange',
            2: 'White',
            3: 'Green',
            4: 'Yellow',
            5: 'Red',
            6: 'Blue'
        };
        return names[value] || 'Unknown';
    }

    function resetCube() {
        // Disable buttons during reset
        const buttons = document.querySelectorAll('.rotation-btn, .reset-btn');
        buttons.forEach(btn => btn.disabled = true);

        fetch('/Home/Reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            updateMatrix(data.matrix);
            // Clear button press history
            buttonPressHistory = [];
            updateHistoryDisplay();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resetting cube: ' + error.message);
        })
        .finally(() => {
            // Re-enable buttons
            const buttons = document.querySelectorAll('.rotation-btn, .reset-btn');
            buttons.forEach(btn => btn.disabled = false);
        });
    }
</script>
